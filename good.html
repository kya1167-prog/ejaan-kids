<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ejaan Kids - å„¿ç«¥å¬å†™</title>
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <!-- Unsplash API Access (Replace with your own API key) -->
    <script>
        // NOTE: This is a demo key. Please replace with your own Unsplash API key for production use
        const UNSPLASH_ACCESS_KEY = 'YOUR_UNSPLASH_ACCESS_KEY_HERE';
        // You can get free API keys from:
        // Unsplash: https://unsplash.com/developers (Free 1000 requests/hour)
        // Pixabay: https://pixabay.com/service/about/api/ (Free forever, 20,000 requests/day)
        // Pexels: https://www.pexels.com/api/ (Free forever, 20,000 requests/month)
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Comic Sans MS', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 600px; margin: 0 auto; }
        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 { color: #667eea; text-align: center; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #888; margin-bottom: 30px; }
        
        /* Mode Selection */
        .mode-select { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .mode-btn {
            flex: 1;
            padding: 15px 20px;
            border: 3px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 15px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            min-width: 120px;
        }
        .mode-btn.active {
            background: #667eea;
            color: white;
        }
        .mode-btn:hover { transform: translateY(-2px); }
        
        /* Parent Input Section */
        .parent-section { display: none; }
        .parent-section.active { display: block; }
        .word-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        .word-input:focus { outline: none; border-color: #667eea; }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .btn:hover { background: #5568d3; transform: translateY(-2px); }
        .btn-secondary { background: #888; }
        .btn-secondary:hover { background: #666; }
        
        /* Word List */
        .word-list {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        .word-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .word-item span { font-size: 18px; }
        .word-item .delete-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
        }
        
        /* Kid Section */
        .kid-section { display: none; }
        .kid-section.active { display: block; }
        
        /* Scene Display */
        .scene {
            text-align: center;
            margin-bottom: 20px;
        }
        .scene-image {
            font-size: 80px;
            margin-bottom: 10px;
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .scene-word {
            font-size: 32px;
            color: #667eea;
            font-weight: bold;
        }
        .speak-btn {
            background: #4CAF50;
            margin-top: 10px;
            padding: 10px 30px;
        }
        
        /* Spelling Area (English/Malay) */
        .spelling-area {
            text-align: center;
            margin: 20px 0;
        }
        .letter-slots {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .letter-slot {
            width: 50px;
            height: 60px;
            border: 3px dashed #667eea;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            background: #f0f0f0;
        }
        .letter-slot.filled {
            background: #667eea;
            color: white;
            border-style: solid;
        }
        
        /* Letter Buttons */
        .letter-buttons {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .letter-btn {
            width: 45px;
            height: 45px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .letter-btn:hover { background: #667eea; color: white; transform: scale(1.1); }
        .letter-btn:disabled {
            background: #ccc;
            border-color: #ccc;
            color: #888;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Chinese Character Writing */
        #character-target {
            width: 200px;
            height: 200px;
            margin: 20px auto;
        }
        .chinese-hint {
            text-align: center;
            color: #888;
            margin-top: 10px;
        }
        
        /* Reward Animation */
        .reward-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .reward-overlay.active { display: flex; }
        .stars {
            font-size: 80px;
            animation: spin 1s ease-in-out;
        }
        @keyframes spin {
            0% { transform: rotate(0deg) scale(0); }
            50% { transform: rotate(180deg) scale(1.5); }
            100% { transform: rotate(360deg) scale(1); }
        }
        .reward-text {
            color: white;
            font-size: 32px;
            margin-top: 20px;
            font-weight: bold;
        }
        .next-btn {
            margin-top: 30px;
            padding: 15px 40px;
            font-size: 20px;
            background: #4CAF50;
        }
        
        /* Progress */
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #ddd;
            border-radius: 5px;
            margin-top: 20px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
        }
        .progress-text {
            text-align: center;
            margin-top: 5px;
            color: #888;
            font-size: 14px;
        }
        
        /* Confetti */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #f00;
            animation: fall 3s linear forwards;
        }
        @keyframes fall {
            to { transform: translateY(100vh) rotate(720deg); }
        }
        
        /* Pulse animation for rewards */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>ğŸ¦ Ejaan Kids - Enhanced Dictation Learning!</h1>
            <p class="subtitle">å„¿ç«¥å¬å†™ Â· å„¿ç«¥å¬å†™æ¸¸æˆ (çº¯å›¾ç‰‡+è¯­éŸ³æ¨¡å¼)</p>
            <div style="background: #e3f2fd; border-radius: 10px; padding: 15px; margin: 15px 0; border-left: 4px solid #2196F3;">
                <p style="margin: 0; color: #333; font-size: 14px;">
                    <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
                    â€¢ å®¶é•¿ï¼šç‚¹å‡»"Parent"æ·»åŠ å•è¯å’Œè®¾ç½®APIå¯†é’¥<br>
                    â€¢ å­©å­ï¼šé€‰æ‹©è¯­è¨€å¼€å§‹çº¯å¬å†™ç»ƒä¹ ï¼ˆåªæœ‰å›¾ç‰‡å’Œè¯­éŸ³æç¤ºï¼‰<br>
                    â€¢ è‡ªåŠ¨è·å–çœŸå®å›¾ç‰‡å¸®åŠ©ç†è§£å•è¯å«ä¹‰<br>
                    â€¢ å®Œæˆç»ƒä¹ è·å¾—æ˜Ÿæ˜Ÿå¥–åŠ±â­
                </p>
            </div>
            
            <!-- Mode Selection -->
            <div class="mode-select">
                <button class="mode-btn" onclick="setMode('english')">ğŸ”¤ English</button>
                <button class="mode-btn" onclick="setMode('malay')">ğŸ‡²ğŸ‡¾ Melayu</button>
                <button class="mode-btn" onclick="setMode('chinese')">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</button>
                <button class="mode-btn" onclick="startQuizFromMenu()">ğŸ® Start Quiz</button>
                <button class="mode-btn active" onclick="showParentSection()">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Parent</button>
            </div>
            
            <!-- Parent Section -->
            <div class="parent-section active" id="parentSection">
                <h2>ğŸ“ Manage Word List</h2>
                <p style="color: #888; margin: 10px 0;">Add words your kid should learn:</p>
                
                <!-- Voice Status Indicator -->
                <div style="background: #e8f5e9; border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid #81c784;">
                    <h3 style="color: #2e7d32; margin-top: 0;">ğŸ”Š Voice Status</h3>
                    <p style="color: #2e7d32; font-size: 13px; margin: 5px 0;">
                        Current voice availability:
                    </p>
                    <div id="voiceStatus" style="font-size: 12px; margin-top: 10px;">
                        <div id="englishVoiceStatus">ğŸ”¤ English: Loading...</div>
                        <div id="malayVoiceStatus">ğŸ‡²ğŸ‡¾ Malay: Loading...</div>
                        <div id="chineseVoiceStatus">ğŸ‡¨ğŸ‡³ Chinese: Loading...</div>
                    </div>
                    <button class="btn" style="margin-top: 10px; padding: 8px 15px; font-size: 12px;" onclick="checkVoiceAvailability()">ğŸ”„ Check Voices</button>
                    <p style="color: #558b2f; font-size: 11px; margin: 10px 0 0 0;">
                        ğŸ’¡ Tip: If Malay voice is not available, please install Malay TTS in your system settings.
                    </p>
                </div>
                
                <!-- Unsplash API Key Setup -->
                <div style="background: #fff3cd; border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid #ffeaa7;">
                    <h3 style="color: #856404; margin-top: 0;">ğŸ”‘ Image Search API Keys</h3>
                    <p style="color: #856404; font-size: 14px; margin: 5px 0;">
                        Get free images for words! Register for free API keys:
                    </p>
                    <ul style="color: #856404; font-size: 13px; margin: 5px 0 10px 20px; padding: 0;">
                        <li><a href="https://unsplash.com/developers" target="_blank" style="color: #007bff;">Unsplash</a> - 1,000 requests/hour free</li>
                        <li><a href="https://pixabay.com/service/about/api/" target="_blank" style="color: #007bff;">Pixabay</a> - 20,000 requests/day free</li>
                        <li><a href="https://www.pexels.com/api/" target="_blank" style="color: #007bff;">Pexels</a> - 20,000 requests/month free</li>
                    </ul>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <input type="password" class="word-input" id="unsplashApiKey" placeholder="Enter your Unsplash API key" 
                               value="" style="flex: 1;">
                        <button class="btn" onclick="saveUnsplashApiKey()" style="padding: 10px 15px;">Save Key</button>
                    </div>
                </div>
                
                <div style="background: #fff3cd; border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid #ffeaa7;">
                    <h3 style="color: #856404; margin-top: 0;">â• Add New Word</h3>
                    <p style="color: #856404; font-size: 14px; margin: 5px 0;">Select language and enter the word:</p>
                    
                    <!-- Language Selection for Adding Word -->
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="btn" id="addWordEngBtn" onclick="setAddWordLanguage('english')" style="flex: 1; padding: 10px; background: #667eea; color: white; border: 2px solid #667eea;">
                            ğŸ”¤ English
                        </button>
                        <button class="btn" id="addWordMalayBtn" onclick="setAddWordLanguage('malay')" style="flex: 1; padding: 10px; background: white; color: #333; border: 2px solid #ddd;">
                            ğŸ‡²ğŸ‡¾ Melayu
                        </button>
                        <button class="btn" id="addWordChineseBtn" onclick="setAddWordLanguage('chinese')" style="flex: 1; padding: 10px; background: white; color: #333; border: 2px solid #ddd;">
                            ğŸ‡¨ğŸ‡³ ä¸­æ–‡
                        </button>
                    </div>
                    
                    <!-- Word Input -->
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" class="word-input" id="newWord" placeholder="Enter word (e.g., fish, ikan, é±¼)" style="flex: 1;">
                        <button class="btn" onclick="addWord()">Add</button>
                    </div>
                </div>
                

                
                <div class="word-list" id="wordList"></div>
                
                <button class="btn" style="width: 100%; margin-top: 20px;" onclick="startQuiz()">ğŸ® Start Quiz!</button>
            </div>
            
            <!-- Kid Section -->
            <div class="kid-section" id="kidSection">
                <!-- Original Spelling Game (Current) -->
                <div id="spellingGame">
                    <div class="scene">
                        <div class="scene-image" id="sceneImage">ğŸŸ</div>
                        <div class="scene-word" id="sceneWord">fish</div>
                        <button class="btn speak-btn" onclick="speakWord()">ğŸ”Š Listen</button>
                    </div>
                    
                    <!-- For English/Malay -->
                    <div id="latinSpelling">
                        <div class="spelling-area">
                            <p style="color: #888; margin-bottom: 10px;">Tap the letters in order!</p>
                            <div class="letter-slots" id="letterSlots"></div>
                            
                            <!-- Action Buttons -->
                            <div style="text-align: center; margin: 15px 0;">
                                <button class="btn" onclick="undoLastLetter()" style="font-size: 16px; padding: 10px 25px; background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); color: #333; border: none; border-radius: 15px; box-shadow: 0 2px 8px rgba(255, 236, 210, 0.4);">
                                    â†©ï¸ Undo
                                </button>
                            </div>
                            
                            <div class="letter-buttons" id="letterButtons"></div>
                        </div>
                    </div>
                    
                    <!-- For Chinese -->
                    <div id="chineseSpelling" style="display: none;">
                        <div id="character-target"></div>
                        <p class="chinese-hint">Trace the character in correct stroke order!</p>
                        
                        <!-- Chinese Hint Button -->
                        <div style="text-align: center; margin: 15px 0;">
                            <button class="btn" onclick="showChineseHint()" style="font-size: 16px; padding: 10px 25px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; border: none; border-radius: 15px; box-shadow: 0 2px 8px rgba(168, 237, 234, 0.4);">
                                ğŸ’¡ Show Next Stroke
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- New Listen and Learn Mode -->
                <div id="listenSelectGame" style="display: none;">
                    <h3 style="text-align: center; color: #667eea; margin-bottom: 20px;">ğŸ§ Listen and Learn</h3>
                    
                    <div style="text-align: center; padding: 20px;">
                        <!-- Word Display -->
                        <div id="listenWordDisplay" style="font-size: 48px; font-weight: bold; color: #333; margin: 20px 0; min-height: 60px;">
                            
                        </div>
                        
                        <!-- Scene/Image Display -->
                        <div id="listenSceneDisplay" style="font-size: 80px; margin: 20px 0;">
                            
                        </div>
                        
                        <!-- Play Sound Button -->
                        <button class="btn speak-btn" onclick="speakWord()" style="font-size: 24px; padding: 20px 40px; margin: 20px 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 25px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                            ğŸ”Š Listen
                        </button>
                        
                        <!-- Navigation Buttons -->
                        <div style="margin-top: 20px; display: flex; justify-content: center; gap: 15px;">
                            <button class="btn" onclick="previousWord()" style="font-size: 18px; padding: 15px 30px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; border: none; border-radius: 20px; box-shadow: 0 4px 15px rgba(168, 237, 234, 0.4);">
                                â¬…ï¸ Previous
                            </button>
                            <button class="btn" onclick="nextWord()" style="font-size: 18px; padding: 15px 30px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 20px; box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);">
                                Next â¡ï¸
                            </button>
                        </div>
                        
                        <!-- Learning Instructions -->
                        <div style="margin-top: 30px; padding: 20px; background: #f0f4ff; border-radius: 15px; border-left: 4px solid #667eea;">
                            <p style="color: #667eea; font-size: 16px; margin: 0;">
                                ğŸ‘† Click "Listen" button to hear the word<br>
                                ğŸ‘€ Look at the word and image<br>
                                ğŸ¯ Practice saying the word yourself!
                            </p>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div style="margin: 20px auto; max-width: 300px; padding: 0 20px;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFillListen" style="width: 0%"></div>
                        </div>
                        <div class="progress-text" id="progressTextListen" style="text-align: center; margin-top: 5px;">Word 0 / 0</div>
                    </div>
                    
                    <div id="resultFeedback" style="text-align: center; min-height: 30px; margin: 15px 0;">
                        <!-- Feedback will appear here -->
                    </div>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="progressText">Word 0 / 0</div>
                
                <!-- Game Mode Toggle -->
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="toggleGameMode()" id="gameModeToggle">Switch to Listen & Learn Mode</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Reward Overlay -->
    <div class="reward-overlay" id="rewardOverlay">
        <div class="stars">â­â­â­</div>
        <div class="reward-text" id="rewardText">awesome!</div>
        <button class="btn next-btn" onclick="nextWord()">Next â†’</button>
    </div>
    
    <script>
        // State
        let currentMode = 'english';
        let quizLanguage = null; // Store the language when quiz starts
        const APP_VERSION = 'v2.7.1'; // Version number for debugging
        // Load initial word list or use defaults
        let wordList = [];
        let chineseWriters = []; // Store Chinese writer instances for hint functionality
        let selectedLetters = []; // Track selected letters for undo
        
        // Initialize word list after loading
        async function initializeWordList() {
            wordList = JSON.parse(localStorage.getItem('ejaanWords')) || [];
            
            // If no words in localStorage, populate with defaults using automatic scene assignment
            if (wordList.length === 0) {
                const defaultWords = [
                    { word: 'fish', lang: 'english' },
                    { word: 'cat', lang: 'english' },
                    { word: 'dog', lang: 'english' },
                    { word: 'ikan', lang: 'malay' },
                    { word: 'kucing', lang: 'malay' },
                    { word: 'é±¼', lang: 'chinese' },
                    { word: 'çŒ«', lang: 'chinese' }
                ];
                
                // Assign scenes automatically
                wordList = [];
                for (const item of defaultWords) {
                    const scene = await getSceneForWord(item.word, item.lang);
                    wordList.push({
                        word: item.word,
                        scene: scene,
                        lang: item.lang
                    });
                }
                
                // Save to localStorage
                saveWords();
            }
            
            renderWordList();
        }
        
        // Initialize word list after loading emoji mapping
        window.addEventListener('DOMContentLoaded', async () => {
            await loadEmojiMapping();
            initializeWordList();
        });
        let quizWords = [];
        let currentWordIndex = 0;
        let currentWord = '';
        let currentInput = '';
        let chineseWriter = null;
        
        // Load emoji mapping on startup and initialize word list
        // This is now handled in the DOMContentLoaded event listener above
        
        // Mode Selection
        function setMode(mode) {
            currentMode = mode;
            
            // Update active button
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find and activate the clicked button
            const buttons = document.querySelectorAll('.mode-btn');
            buttons.forEach(btn => {
                if (btn.textContent.includes('English') && mode === 'english') {
                    btn.classList.add('active');
                } else if (btn.textContent.includes('Melayu') && mode === 'malay') {
                    btn.classList.add('active');
                } else if (btn.textContent.includes('ä¸­æ–‡') && mode === 'chinese') {
                    btn.classList.add('active');
                }
            });
            
            console.log('Mode changed to:', mode);
        }
        
        // Start quiz from menu with selected language
        function startQuizFromMenu() {
            // Check if there are words in the selected language
            const wordsInLanguage = wordList.filter(w => w.lang === currentMode);
            if (wordsInLanguage.length === 0) {
                const msg = currentMode === 'malay' ? 'Tiada perkataan dalam bahasa ini. Sila tambah perkataan di Parent mode.' :
                           currentMode === 'chinese' ? 'è¿™ç§è¯­è¨€æ²¡æœ‰å•è¯ã€‚è¯·åœ¨Parentæ¨¡å¼æ·»åŠ å•è¯ã€‚' :
                           'No words in this language. Please add words in Parent mode.';
                alert(msg);
                return;
            }
            
            // Start quiz directly
            startQuiz();
        }
        
        // Parent Section
        function showParentSection() {
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('parentSection').classList.add('active');
            document.getElementById('kidSection').classList.remove('active');
            renderWordList();
            
            // Check voice availability when parent section is shown
            checkVoiceAvailability();
        }
        
        // Load emoji mapping
        let emojiMap = {};
        
        // Function to load emoji mapping from JSON file
        async function loadEmojiMapping() {
            try {
                const response = await fetch('word-emoji-map.json');
                emojiMap = await response.json();
                console.log('Emoji mapping loaded successfully');
            } catch (error) {
                console.error('Failed to load emoji mapping:', error);
                // Fallback to basic mapping
                emojiMap = {
                    "animals": {"fish": "ğŸŸ", "cat": "ğŸ±", "dog": "ğŸ•"},
                    "malay": {"ikan": "ğŸŸ", "kucing": "ğŸ±", "anjing": "ğŸ•"},
                    "chinese": {"é±¼": "ğŸŸ", "çŒ«": "ğŸ±", "ç‹—": "ğŸ•"}
                };
            }
        }
        
        // Simplified function - no image generation to avoid external dependencies
        async function generateImageForWord(word, lang) {
            // Simply return null to indicate no image is available
            // This avoids the need for external services that cause authorization issues
            return null;
        }
        
        // Multi-API Image Search Function with fallbacks
        async function searchImage(query, lang) {
            // Translation map for better search results
            const translationMap = {
                // Malay to English mappings
                'ikan': 'fish',
                'kucing': 'cat',
                'anjing': 'dog',
                'burung': 'bird',
                'ayam': 'chicken',
                'babi': 'pig',
                'kerbau': 'buffalo',
                'harimau': 'tiger',
                'singa': 'lion',
                'gajah': 'elephant',
                'ular': 'snake',
                'semut': 'ant',
                'lebah': 'bee',
                // Chinese to English mappings
                'é±¼': 'fish',
                'çŒ«': 'cat',
                'ç‹—': 'dog',
                'é¸Ÿ': 'bird',
                'é¸¡': 'chicken',
                'çŒª': 'pig',
                'ç‰›': 'cow',
                'è™': 'tiger',
                'å…”': 'rabbit',
                'è±¡': 'elephant',
                'é©¬': 'horse',
                'ç¾Š': 'sheep',
                'é¹¿': 'deer',
                'ç†Š': 'bear',
                'ç‹®': 'lion',
                'çŒ´': 'monkey',
                'è›™': 'frog',
                'è›‡': 'snake',
                'é¸­': 'duck',
                'é¹…': 'goose',
                'è‹¹æœ': 'apple',
                'é¦™è•‰': 'banana',
                'æ©™å­': 'orange',
                'è‘¡è„': 'grape',
                'è¥¿ç“œ': 'watermelon',
                'è‰è“': 'strawberry',
                'ç±³é¥­': 'rice',
                'é¢åŒ…': 'bread',
                'é¸¡è›‹': 'egg',
                'ç‰›å¥¶': 'milk'
            };
            
            // Try direct translation if available
            const translatedQuery = translationMap[query] || query;
            
            // API configurations
            const apis = [
                {
                    name: 'Unsplash',
                    url: `https://api.unsplash.com/search/photos?query=${encodeURIComponent(translatedQuery)}&per_page=1&page=1`,
                    headers: { 'Authorization': `Client-ID ${getUnsplashApiKey()}` },
                    extractUrl: (data) => data.results && data.results[0] ? data.results[0].urls.small : null
                },
                {
                    name: 'Pixabay',
                    url: `https://pixabay.com/api/?key=45161705-495a96af8099b0e43ebae03ec&q=${encodeURIComponent(translatedQuery)}&per_page=1&safesearch=true`,
                    headers: {},
                    extractUrl: (data) => data.hits && data.hits[0] ? data.hits[0].webformatURL : null
                },
                {
                    name: 'Pexels',
                    url: `https://api.pexels.com/v1/search?query=${encodeURIComponent(translatedQuery)}&per_page=1`,
                    headers: { 'Authorization': '563492ad6f91700001000001e44d0d7e0d5c4cf0a0f1c0d5e3a9e2a9' },
                    extractUrl: (data) => data.photos && data.photos[0] ? data.photos[0].src.medium : null
                }
            ];
            
            // Try each API in order
            for (const api of apis) {
                try {
                    // Skip if API key is missing
                    if ((api.name === 'Unsplash' && (!getUnsplashApiKey() || getUnsplashApiKey() === 'YOUR_UNSPLASH_ACCESS_KEY_HERE'))) {
                        continue;
                    }
                    
                    const response = await fetch(api.url, { headers: api.headers });
                    
                    if (!response.ok) {
                        console.warn(`${api.name} API error: ${response.status}`);
                        continue;
                    }
                    
                    const data = await response.json();
                    const imageUrl = api.extractUrl(data);
                    
                    if (imageUrl) {
                        console.log(`Found image from ${api.name}: ${imageUrl}`);
                        return imageUrl;
                    }
                } catch (error) {
                    console.warn(`Failed to fetch image from ${api.name}:`, error);
                    continue;
                }
            }
            
            // No images found from any API
            console.warn(`No images found for query: ${query}`);
            return null;
        }
        
        // Get emoji or image for a word based on language
        async function getSceneForWord(word, lang) {
            word = word.toLowerCase().trim();
            
            // Try to find emoji in mapping
            try {
                if (lang === 'english' || lang === 'malay') {
                    // Check English categories
                    for (const category in emojiMap) {
                        if (emojiMap[category][word]) {
                            return { type: 'emoji', value: emojiMap[category][word] };
                        }
                    }
                    
                    // Check Malay category specifically
                    if (lang === 'malay' && emojiMap.malay && emojiMap.malay[word]) {
                        return { type: 'emoji', value: emojiMap.malay[word] };
                    }
                } else if (lang === 'chinese') {
                    // For Chinese, check the Chinese category
                    if (emojiMap.chinese && emojiMap.chinese[word]) {
                        return { type: 'emoji', value: emojiMap.chinese[word] };
                    }
                }
            } catch (error) {
                console.warn('Error looking up emoji:', error);
            }
            
            // Try to get image from multi-API search
            const imageURL = await searchImage(word, lang);
            if (imageURL) {
                return { type: 'image', value: imageURL };
            }
            
            // Fallback emojis based on language
            const fallbackEmojis = {
                'english': 'â­',
                'malay': 'ğŸ‡²ğŸ‡¾',
                'chinese': 'ğŸ‡¨ğŸ‡³'
            };
            
            return { type: 'emoji', value: fallbackEmojis[lang] || 'â­' };
        }
        
        // Language selection for adding words
        let addWordLanguage = 'english';
        
        function setAddWordLanguage(lang) {
            addWordLanguage = lang;
            
            // Update button styles
            const engBtn = document.getElementById('addWordEngBtn');
            const malayBtn = document.getElementById('addWordMalayBtn');
            const chineseBtn = document.getElementById('addWordChineseBtn');
            
            // Reset all buttons
            [engBtn, malayBtn, chineseBtn].forEach(btn => {
                btn.style.background = 'white';
                btn.style.color = '#333';
                btn.style.border = '2px solid #ddd';
            });
            
            // Highlight selected button
            if (lang === 'english') {
                engBtn.style.background = '#667eea';
                engBtn.style.color = 'white';
                engBtn.style.border = '2px solid #667eea';
            } else if (lang === 'malay') {
                malayBtn.style.background = '#667eea';
                malayBtn.style.color = 'white';
                malayBtn.style.border = '2px solid #667eea';
            } else if (lang === 'chinese') {
                chineseBtn.style.background = '#667eea';
                chineseBtn.style.color = 'white';
                chineseBtn.style.border = '2px solid #667eea';
            }
            
            // Update placeholder text
            const wordInput = document.getElementById('newWord');
            if (lang === 'english') {
                wordInput.placeholder = 'Enter word (e.g., fish, cat, dog)';
            } else if (lang === 'malay') {
                wordInput.placeholder = 'Masukkan perkataan (e.g., ikan, kucing, anjing)';
            } else if (lang === 'chinese') {
                wordInput.placeholder = 'è¾“å…¥æ±‰å­— (e.g., é±¼, çŒ«, ç‹—)';
            }
        }
        
        async function addWord() {
            const wordInput = document.getElementById('newWord');
            const word = wordInput.value.trim();
            
            if (!word) {
                const langMsg = addWordLanguage === 'malay' ? 'Sila masukkan perkataan!' : 
                               addWordLanguage === 'chinese' ? 'è¯·è¾“å…¥ä¸€ä¸ªå­—ï¼' : 
                               'Please enter a word!';
                alert(langMsg);
                return;
            }
            
            // Get scene automatically based on word and language
            const scene = await getSceneForWord(word, addWordLanguage);
            
            wordList.push({
                word: word,
                scene: scene,
                lang: addWordLanguage
            });
            
            saveWords();
            renderWordList();
            wordInput.value = '';
        }
        
        // Load emoji mapping when page loads
        window.addEventListener('load', function() {
            loadEmojiMapping();
            
            // Initialize add word language selection
            setAddWordLanguage('english');
        });
        
        function deleteWord(index) {
            wordList.splice(index, 1);
            saveWords();
            renderWordList();
        }
        
        function saveWords() {
            localStorage.setItem('ejaanWords', JSON.stringify(wordList));
        }
        
        function renderWordList() {
            const listEl = document.getElementById('wordList');
            listEl.innerHTML = wordList.map((item, i) => {
                // Handle both old format (emoji) and new format (scene)
                let displayScene = 'â­';
                if (item.scene) {
                    if (item.scene.type === 'emoji') {
                        displayScene = item.scene.value;
                    } else if (item.scene.type === 'image') {
                        displayScene = 'ğŸ–¼ï¸'; // Image icon
                    }
                } else if (item.emoji) {
                    displayScene = item.emoji;
                }
                
                return `
                    <div class="word-item">
                        <span>${displayScene} ${item.word} (${item.lang})</span>
                        <button class="delete-btn" onclick="deleteWord(${i})">Ã—</button>
                    </div>
                `;
            }).join('');
        }
        
        function selectImage() {
            alert('Now using Emoji scene generation!\n\nJust enter a word and we\'ll automatically find a matching emoji scene.\n\nExamples:\nâ€¢ "fish" â†’ ğŸŸ\nâ€¢ "cat" â†’ ğŸ±\nâ€¢ "ikan" â†’ ğŸŸ\nâ€¢ "è‹¹æœ" â†’ ğŸ');
        }
        
        // Unsplash API Key Functions
        function saveUnsplashApiKey() {
            const apiKeyInput = document.getElementById('unsplashApiKey');
            const apiKey = apiKeyInput.value.trim();
            
            if (!apiKey) {
                alert('Please enter a valid API key!');
                return;
            }
            
            localStorage.setItem('unsplashApiKey', apiKey);
            alert('API key saved successfully!');
            
            // Update global variable
            window.unsplashApiKey = apiKey;
        }
        
        function getUnsplashApiKey() {
            return localStorage.getItem('unsplashApiKey') || UNSPLASH_ACCESS_KEY;
        }
        
        // Quiz Functions
        function startQuiz() {
            // Filter words by current mode
            quizWords = wordList.filter(w => w.lang === currentMode);
            
            if (quizWords.length === 0) {
                alert('Add some words first!');
                return;
            }
            
            // Save the quiz language at start - this won't change during quiz
            quizLanguage = currentMode;
            
            // Shuffle
            quizWords.sort(() => Math.random() - 0.5);
            currentWordIndex = 0;
            
            document.getElementById('parentSection').classList.remove('active');
            document.getElementById('kidSection').classList.add('active');
            
            loadWord();
        }
        
        function selectImage() {
            alert('Now using Emoji scene generation!\n\nJust enter a word and we\'ll automatically find a matching emoji scene.\n\nExamples:\nâ€¢ "fish" â†’ ğŸŸ\nâ€¢ "cat" â†’ ğŸ±\nâ€¢ "ikan" â†’ ğŸŸ\nâ€¢ "è‹¹æœ" â†’ ğŸ');
        }
        
        // Load word function with listening mode support
        function loadWord() {
            if (currentWordIndex >= quizWords.length) {
                // Quiz complete!
                showFinalReward();
                return;
            }
            
            currentWord = quizWords[currentWordIndex];
            currentInput = '';
            
            // Check if in listen mode
            if (currentGameMode === 'listenSelect') {
                // In listen mode, call loadListenSelectGame
                loadListenSelectGame();
                updateProgress();
                return;
            }
            
            // Update scene - handle both emoji and image
            const sceneElement = document.getElementById('sceneImage');
            if (currentWord.scene) {
                if (currentWord.scene.type === 'emoji') {
                    sceneElement.textContent = currentWord.scene.value;
                    sceneElement.innerHTML = currentWord.scene.value; // For emojis
                } else if (currentWord.scene.type === 'image' && currentWord.scene.value) {
                    sceneElement.innerHTML = `<img src="${currentWord.scene.value}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 10px;">`;
                } else {
                    sceneElement.textContent = 'â­'; // Fallback
                }
            } else if (currentWord.emoji) {
                sceneElement.textContent = currentWord.emoji;
            } else {
                sceneElement.textContent = 'â­'; // Fallback
            }
            
            // Always hide word text - only show images and audio for pure dictation practice
            const sceneWordElement = document.getElementById('sceneWord');
            sceneWordElement.textContent = ''; // Hide the word
            sceneWordElement.style.display = 'none';
            
            // Play sound automatically (optional)
            setTimeout(() => speakWord(), 500);
            
            // Show correct input method - use quizLanguage, not currentMode
            const activeLanguage = quizLanguage || currentMode;
            if (activeLanguage === 'chinese') {
                document.getElementById('latinSpelling').style.display = 'none';
                document.getElementById('chineseSpelling').style.display = 'block';
                initChineseWriter(currentWord.word);
            } else {
                document.getElementById('latinSpelling').style.display = 'block';
                document.getElementById('chineseSpelling').style.display = 'none';
                setupLatinSpelling();
            }
            
            updateProgress();
        }
        
        // Latin Alphabet Spelling (English/Malay)
        function setupLatinSpelling() {
            const word = currentWord.word;
            const slots = document.getElementById('letterSlots');
            const buttons = document.getElementById('letterButtons');
            
            // Reset selected letters for undo
            selectedLetters = [];
            
            // Create letter slots
            slots.innerHTML = word.split('').map((_, i) => 
                `<div class="letter-slot" data-index="${i}"></div>`
            ).join('');
            
            // Create shuffled letter buttons (no need for unique IDs)
            const letters = [...word]; // Create a copy of the letters
            shuffleArray(letters);
            
            buttons.innerHTML = letters.map((char, i) => `
                <button class="letter-btn" data-index="${i}">${char}</button>
            `).join('');
            
            // Add click event listeners
            const letterButtons = buttons.querySelectorAll('.letter-btn');
            letterButtons.forEach((btn, index) => {
                btn.addEventListener('click', function() {
                    selectLetter(this.textContent, this);
                });
            });
        }
        
        function selectLetter(char, buttonElement) {
            currentInput += char;
            
            // Track the selected letter and its button for undo
            selectedLetters.push({
                char: char,
                button: buttonElement
            });
            
            // Find next empty slot
            const slots = document.querySelectorAll('.letter-slot');
            let filled = 0;
            slots.forEach(slot => {
                if (slot.textContent) filled++;
            });
            
            if (filled < slots.length) {
                slots[filled].textContent = char;
                slots[filled].classList.add('filled');
            }
            
            // Disable the clicked button
            buttonElement.disabled = true;
            buttonElement.classList.add('used');
            
            // Check if complete
            if (currentInput.length === currentWord.word.length) {
                checkAnswer();
            }
        }
        
        // Undo the last selected letter
        function undoLastLetter() {
            if (selectedLetters.length === 0) {
                return; // Nothing to undo
            }
            
            // Get the last selected letter
            const lastSelected = selectedLetters.pop();
            
            // Remove from current input
            currentInput = currentInput.slice(0, -1);
            
            // Re-enable the button
            lastSelected.button.disabled = false;
            lastSelected.button.classList.remove('used');
            
            // Clear the last filled slot
            const slots = document.querySelectorAll('.letter-slot');
            const filledSlots = Array.from(slots).filter(slot => slot.textContent);
            if (filledSlots.length > 0) {
                const lastSlot = filledSlots[filledSlots.length - 1];
                lastSlot.textContent = '';
                lastSlot.classList.remove('filled');
            }
        }
        
        // Chinese Character Writing with multi-character support
        let currentStrokeNum = 0; // Track current stroke number
        let currentCharIndex = 0; // Track which character in multi-char word (0-indexed)
        
        function initChineseWriter(chars) {
            document.getElementById('character-target').innerHTML = '';
            
            // Reset writers array and stroke counter
            chineseWriters = [];
            currentStrokeNum = 0;
            currentCharIndex = 0; // Reset to first character
            
            // For multi-character words, we need to handle them differently
            if (chars.length > 1) {
                // Create a container for multiple characters with horizontal layout
                const container = document.createElement('div');
                container.style.display = 'flex';
                container.style.justifyContent = 'center';
                container.style.alignItems = 'center';
                container.style.gap = '30px'; // Increased spacing between characters
                container.style.flexWrap = 'nowrap'; // Prevent wrapping to keep horizontal layout
                container.style.margin = '20px 0'; // Add vertical spacing
                
                // Create individual writers for each character
                for (let i = 0; i < chars.length; i++) {
                    const charDiv = document.createElement('div');
                    charDiv.id = `character-${i}`;
                    charDiv.style.width = '160px'; // Slightly larger for better visibility
                    charDiv.style.height = '160px';
                    charDiv.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)'; // Add subtle shadow
                    charDiv.style.borderRadius = '10px'; // Rounded corners
                    container.appendChild(charDiv);
                }
                
                document.getElementById('character-target').appendChild(container);
                
                // Initialize writers for each character
                let completedChars = 0;
                const totalChars = chars.length;
                
                for (let i = 0; i < chars.length; i++) {
                    const char = chars[i];
                    const charDivId = `character-${i}`;
                    
                    const writer = HanziWriter.create(charDivId, char, {
                        width: 160,
                        height: 160,
                        padding: 10, // Increased padding for better appearance
                        showOutline: true,
                        strokeAnimationSpeed: 1,
                        delayBetweenStrokes: 500,
                        showHintAfterMisses: 3,
                        highlightOnComplete: true,
                        strokeHighlightDuration: 500,
                    });
                    
                    // Save writer instance for hint functionality
                    chineseWriters.push(writer);
                    
                    // Start quiz mode for each character
                    writer.quiz({
                        onMistake: function(strokeData) {
                            currentStrokeNum = strokeData.strokeNum; // Track current stroke
                            currentCharIndex = i; // Track which character
                            
                            // Gentle feedback for mistakes with character reference
                            if (strokeData.totalMistakes === 1) {
                                alert(`Character ${i+1} ("${char}") - å†è¯•ä¸€æ¬¡ï¼Try again!`);
                            } else if (strokeData.totalMistakes === 2) {
                                alert(`Character ${i+1} ("${char}") - ä»”ç»†çœ‹çœ‹ç¬”ç”»é¡ºåºï¼Look carefully at the stroke order!`);
                            }
                        },
                        onCorrectStroke: function(strokeData) {
                            currentStrokeNum = strokeData.strokeNum + 1; // Update to next stroke
                            currentCharIndex = i; // Track which character
                            
                            // Positive feedback on correct stroke with character reference
                            console.log(`Character ${i+1} ("${char}") - Good! Stroke ${strokeData.strokeNum + 1} correct!`);
                        },
                        onComplete: function(summaryData) {
                            completedChars++;
                            currentStrokeNum = 0; // Reset for next character
                            currentCharIndex = i + 1; // Move to next character
                            console.log(`Character ${i+1} ("${char}") writing complete!`, summaryData);
                            
                            // If all characters are completed, check answer
                            if (completedChars === totalChars) {
                                checkAnswer();
                            }
                        }
                    });
                }
            } else {
                // Single character (original behavior)
                chineseWriter = HanziWriter.create('character-target', chars, {
                    width: 200,
                    height: 200,
                    padding: 5,
                    showOutline: true,
                    strokeAnimationSpeed: 1,
                    delayBetweenStrokes: 500,
                    showHintAfterMisses: 3,
                    highlightOnComplete: true,
                    strokeHighlightDuration: 500,
                });
                
                // Save writer instance for hint functionality
                chineseWriters = [chineseWriter];
                
                // Start quiz mode
                chineseWriter.quiz({
                    onMistake: function(strokeData) {
                        currentStrokeNum = strokeData.strokeNum; // Track current stroke
                        
                        // Gentle feedback for mistakes
                        if (strokeData.totalMistakes === 1) {
                            alert('å†è¯•ä¸€æ¬¡ï¼Try again!');
                        } else if (strokeData.totalMistakes === 2) {
                            alert('ä»”ç»†çœ‹çœ‹ç¬”ç”»é¡ºåºï¼Look carefully at the stroke order!');
                        }
                    },
                    onCorrectStroke: function(strokeData) {
                        currentStrokeNum = strokeData.strokeNum + 1; // Update to next stroke
                        
                        // Positive feedback on correct stroke
                        console.log(`Good! Stroke ${strokeData.strokeNum + 1} correct!`);
                    },
                    onComplete: function(summaryData) {
                        currentStrokeNum = 0; // Reset
                        // Show summary and check answer
                        console.log('Character writing complete!', summaryData);
                        checkAnswer();
                    }
                });
            }
        }
        
        // Show Chinese character hint - show ONLY the next stroke
        function showChineseHint() {
            if (chineseWriters && chineseWriters.length > 0 && currentWord) {
                // Get the current character being written
                const allChars = currentWord.word.split('');
                const currentChar = allChars[currentCharIndex] || allChars[0];
                
                // Get target div for the current character
                let targetDivId = 'character-target';
                if (chineseWriters.length > 1) {
                    // Multi-character: use specific character div
                    targetDivId = `character-${currentCharIndex}`;
                }
                const targetDiv = document.getElementById(targetDivId);
                
                if (!targetDiv) {
                    console.error('Target div not found:', targetDivId);
                    return;
                }
                
                // Create a temporary overlay for hint
                const hintOverlay = document.createElement('div');
                hintOverlay.id = 'hint-overlay';
                hintOverlay.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: ${chineseWriters.length > 1 ? '160px' : '200px'};
                    height: ${chineseWriters.length > 1 ? '160px' : '200px'};
                    z-index: 100;
                    pointer-events: none;
                `;
                targetDiv.style.position = 'relative';
                targetDiv.appendChild(hintOverlay);
                
                // Create temporary writer for hint animation
                const hintWriter = HanziWriter.create('hint-overlay', currentChar, {
                    width: chineseWriters.length > 1 ? 160 : 200,
                    height: chineseWriters.length > 1 ? 160 : 200,
                    padding: chineseWriters.length > 1 ? 10 : 5,
                    showOutline: false,
                    strokeColor: '#FF6B6B', // Red color for hint
                    strokeAnimationSpeed: 1,
                    delayBetweenStrokes: 0,
                });
                
                // Animate only the current stroke
                hintWriter.animateStroke(currentStrokeNum, {
                    duration: 1000
                });
                
                // Remove hint overlay after animation
                setTimeout(() => {
                    if (document.getElementById('hint-overlay')) {
                        document.getElementById('hint-overlay').remove();
                    }
                }, 1200);
            }
        }
        
        // Check Answer
        function checkAnswer() {
            let correct = false;
            
            // Use quizLanguage if available (during quiz), otherwise use currentMode
            const activeLanguage = quizLanguage || currentMode;
            
            if (activeLanguage === 'chinese') {
                // Chinese is handled by Hanzi Writer onComplete
                correct = true;
            } else {
                correct = currentInput === currentWord.word;
            }
            
            if (correct) {
                showReward();
            } else {
                // Wrong - retry
                setTimeout(() => {
                    alert('Try again! ğŸ”Š');
                    speakWord();
                    if (activeLanguage !== 'chinese') {
                        currentInput = '';
                        document.querySelectorAll('.letter-slot').forEach(s => {
                            s.textContent = '';
                            s.classList.remove('filled');
                        });
                        document.querySelectorAll('.letter-btn').forEach(b => b.disabled = false);
                    }
                }, 500);
            }
        }
        
        // Game mode toggle
        let currentGameMode = 'spelling'; // 'spelling' or 'listenSelect'
        
        function toggleGameMode() {
            const spellingGame = document.getElementById('spellingGame');
            const listenSelectGame = document.getElementById('listenSelectGame');
            const toggleButton = document.getElementById('gameModeToggle');
            
            if (currentGameMode === 'spelling') {
                // Switch to listen and learn mode
                spellingGame.style.display = 'none';
                listenSelectGame.style.display = 'block';
                currentGameMode = 'listenSelect';
                toggleButton.textContent = 'Switch to Spelling Mode';
                
                // Load the listen and learn mode
                if (currentWord) {
                    loadListenSelectGame();
                }
            } else {
                // Switch back to spelling mode
                spellingGame.style.display = 'block';
                listenSelectGame.style.display = 'none';
                currentGameMode = 'spelling';
                toggleButton.textContent = 'Switch to Listen & Learn Mode';
                
                // Reload current word in spelling mode
                if (currentWord) {
                    loadWord();
                }
            }
        }
        
        // Load listen and learn mode
        async function loadListenSelectGame() {
            if (!currentWord) return;
            
            // Display the word
            const wordDisplay = document.getElementById('listenWordDisplay');
            if (wordDisplay) {
                wordDisplay.textContent = currentWord.word;
            }
            
            // Display the scene (emoji or image)
            const sceneDisplay = document.getElementById('listenSceneDisplay');
            if (sceneDisplay) {
                let sceneHTML = '';
                if (currentWord.scene) {
                    if (currentWord.scene.type === 'emoji') {
                        sceneHTML = currentWord.scene.value;
                    } else if (currentWord.scene.type === 'image' && currentWord.scene.value) {
                        sceneHTML = `<img src="${currentWord.scene.value}" style="width: 150px; height: 150px; object-fit: cover; border-radius: 20px; border: 4px solid #667eea;">`;
                    }
                } else if (currentWord.emoji) {
                    sceneHTML = currentWord.emoji;
                } else {
                    sceneHTML = 'â­';
                }
                sceneDisplay.innerHTML = sceneHTML;
            }
            
            // Update progress
            const progressFillListen = document.getElementById('progressFillListen');
            const progressTextListen = document.getElementById('progressTextListen');
            if (progressFillListen && progressTextListen) {
                const percent = (currentWordIndex / quizWords.length) * 100;
                progressFillListen.style.width = percent + '%';
                progressTextListen.textContent = `Word ${currentWordIndex + 1} / ${quizWords.length}`;
            }
            
            // Clear feedback
            document.getElementById('resultFeedback').innerHTML = '';
            
            // Automatically play the word once when loaded
            setTimeout(() => speakWord(), 500);
        }
        
        // Handle image selection
        function selectImageOption(selectedWord, isCorrect) {
            const feedbackElement = document.getElementById('resultFeedback');
            
            if (isCorrect) {
                feedbackElement.innerHTML = '<span style="color: #4CAF50; font-size: 24px; font-weight: bold;">âœ… Correct! Well done!</span>';
                showReward();
            } else {
                feedbackElement.innerHTML = '<span style="color: #f44336; font-size: 24px; font-weight: bold;">âŒ Try again!</span>';
                speakWord(); // Play the correct word sound again
            }
        }
        
        // Enhanced reward system with multiple animations
        function showReward() {
            // Different rewards based on performance
            const phrases = ['awesome!', 'brilliant!', 'hebat!', 'å¤ªæ£’äº†!', 'Excellent!', 'Great job!', 'Well done!', 'Fantastic!'];
            const emojis = ['ğŸŒŸ', 'ğŸ‰', 'ğŸŠ', 'ğŸ†', 'ğŸ‘‘', 'ğŸ’', 'ğŸš€', 'ğŸŒˆ'];
            
            // Select random phrase and emoji
            const phrase = phrases[Math.floor(Math.random() * phrases.length)];
            const emoji = emojis[Math.floor(Math.random() * emojis.length)];
            
            document.getElementById('rewardText').innerHTML = `${emoji} ${phrase} ${emoji}`;
            document.getElementById('rewardOverlay').classList.add('active');
            createConfetti();
            playSuccessSound();
            
            // Additional visual feedback
            document.getElementById('rewardText').style.fontSize = '36px';
            document.getElementById('rewardText').style.animation = 'pulse 0.5s 3';
        }
        
        function showFinalReward() {
            document.getElementById('rewardText').innerHTML = 'ğŸ‰ QUIZ COMPLETE! ğŸ‰<br>ğŸ† GREAT JOB! ğŸ†';
            document.getElementById('rewardText').style.fontSize = '28px';
            document.getElementById('rewardOverlay').classList.add('active');
            createConfetti();
            createConfetti();
            createConfetti();
            
            // Special final reward animation
            document.getElementById('rewardText').style.animation = 'bounce 1s infinite';
            
            // Change the Next button to "Back to Home" button
            const nextBtn = document.querySelector('.next-btn');
            if (nextBtn) {
                nextBtn.textContent = 'ğŸ  Back to Home';
                nextBtn.onclick = function() {
                    document.getElementById('rewardOverlay').classList.remove('active');
                    // Reset quiz
                    currentWordIndex = 0;
                    quizWords = [];
                    quizLanguage = null; // Reset quiz language
                    // Go back to parent section
                    document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelector('[onclick="showParentSection()"]').classList.add('active');
                    document.getElementById('parentSection').classList.add('active');
                    document.getElementById('kidSection').classList.remove('active');
                    // Reset button for next quiz
                    nextBtn.textContent = 'Next â†’';
                    nextBtn.onclick = nextWord;
                };
            }
        }
        
        function nextWord() {
            document.getElementById('rewardOverlay').classList.remove('active');
            currentWordIndex++;
            loadWord();
        }
        
        function previousWord() {
            if (currentWordIndex > 0) {
                currentWordIndex--;
                loadWord();
            }
        }
        
        function updateProgress() {
            const percent = (currentWordIndex / quizWords.length) * 100;
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = 
                `Word ${currentWordIndex + 1} / ${quizWords.length}`;
        }
        
        // TTS with enhanced features
        // TTS Voice Management Functions
        let availableVoices = [];
        let voicesLoaded = false;
        
        // Load available voices
        function loadVoices() {
            return new Promise((resolve) => {
                const voices = speechSynthesis.getVoices();
                if (voices.length > 0) {
                    availableVoices = voices;
                    voicesLoaded = true;
                    resolve(voices);
                    return;
                }
                
                // Wait for voices to load
                speechSynthesis.addEventListener('voiceschanged', () => {
                    availableVoices = speechSynthesis.getVoices();
                    voicesLoaded = true;
                    resolve(availableVoices);
                }, { once: true });
            });
        }
        
        // Check voice availability and update UI
        async function checkVoiceAvailability() {
            // Ensure voices are loaded
            if (!voicesLoaded) {
                await loadVoices();
            }
            
            // Update UI for each language
            const englishStatus = document.getElementById('englishVoiceStatus');
            const malayStatus = document.getElementById('malayVoiceStatus');
            const chineseStatus = document.getElementById('chineseVoiceStatus');
            
            // English
            const englishVoice = getBestVoiceForLanguage('english');
            if (englishStatus) {
                if (englishVoice) {
                    englishStatus.innerHTML = `ğŸ”¤ English: âœ… ${englishVoice.name} (${englishVoice.lang})`;
                    englishStatus.style.color = '#2e7d32';
                } else {
                    englishStatus.innerHTML = 'ğŸ”¤ English: âŒ Not available';
                    englishStatus.style.color = '#c62828';
                }
            }
            
            // Malay
            const malayVoice = getBestVoiceForLanguage('malay');
            if (malayStatus) {
                if (malayVoice) {
                    malayStatus.innerHTML = `ğŸ‡²ğŸ‡¾ Malay: âœ… ${malayVoice.name} (${malayVoice.lang})`;
                    malayStatus.style.color = '#2e7d32';
                } else {
                    malayStatus.innerHTML = 'ğŸ‡²ğŸ‡¾ Malay: âŒ Not available - <a href="https://support.microsoft.com/en-us/windows/download-language-packs-for-windows-10-1c9d1a3b-1e1b-1b3a-1b3c-1d1d1e1d1d1d" target="_blank" style="color: #007bff;">How to install</a>';
                    malayStatus.style.color = '#c62828';
                }
            }
            
            // Chinese
            const chineseVoice = getBestVoiceForLanguage('chinese');
            if (chineseStatus) {
                if (chineseVoice) {
                    chineseStatus.innerHTML = `ğŸ‡¨ğŸ‡³ Chinese: âœ… ${chineseVoice.name} (${chineseVoice.lang})`;
                    chineseStatus.style.color = '#2e7d32';
                } else {
                    chineseStatus.innerHTML = 'ğŸ‡¨ğŸ‡³ Chinese: âŒ Not available';
                    chineseStatus.style.color = '#c62828';
                }
            }
        }
        
        // Get the best voice for a specific language
        function getBestVoiceForLanguage(lang) {
            if (!voicesLoaded) {
                console.warn('Voices not loaded yet');
                return null;
            }
            
            let bestVoice = null;
            
            // Language code mapping for better matching
            const langMap = {
                'english': ['en-US', 'en-GB', 'en-AU', 'en'],
                'malay': ['ms-MY', 'ms', 'id-ID', 'id'], // ms-MY for Malay, fallback to Indonesian
                'chinese': ['zh-CN', 'zh-TW', 'zh-HK', 'zh']
            };
            
            const targetLangs = langMap[lang] || [lang];
            
            // Try to find the best matching voice
            for (const targetLang of targetLangs) {
                // First, try exact match
                bestVoice = availableVoices.find(v => v.lang === targetLang);
                if (bestVoice) {
                    console.log(`Found exact match for ${lang}: ${bestVoice.name} (${bestVoice.lang})`);
                    return bestVoice;
                }
                
                // Then, try partial match (starts with)
                bestVoice = availableVoices.find(v => v.lang.startsWith(targetLang.split('-')[0]));
                if (bestVoice) {
                    console.log(`Found partial match for ${lang}: ${bestVoice.name} (${bestVoice.lang})`);
                    return bestVoice;
                }
            }
            
            console.warn(`No voice found for language: ${lang}`);
            return null;
        }
        
        // Check if voice is available for language
        function isVoiceAvailableForLanguage(lang) {
            const voice = getBestVoiceForLanguage(lang);
            return voice !== null;
        }
        
        // Initialize voices when page loads
        if (typeof speechSynthesis !== 'undefined') {
            loadVoices().then(() => {
                // Check voice availability after voices are loaded
                setTimeout(checkVoiceAvailability, 500);
            });
        }
        
        // TTS with Google Translate fallback for Malay
        function speakWord() {
            const word = currentWord.word;
            
            // Use quizLanguage if available (during quiz), otherwise use currentMode
            const activeLanguage = quizLanguage || currentMode;
            
            // Get the best voice for the current language
            const bestVoice = getBestVoiceForLanguage(activeLanguage);
            
            // For Malay, check if local voice is available, otherwise use Google Translate
            if (activeLanguage === 'malay' && !bestVoice) {
                console.log('No Malay TTS voice found, using Google Translate TTS');
                speakWithGoogleTTS(word, 'ms');
                return;
            }
            
            // Use Web Speech API for other languages or if local voice is available
            const utterance = new SpeechSynthesisUtterance(word);
            
            // Set language and properties
            if (activeLanguage === 'english') {
                utterance.lang = 'en-US';
                utterance.rate = 0.8; // Slightly slower for clarity
            } else if (activeLanguage === 'malay') {
                utterance.lang = 'ms-MY';
                utterance.rate = 0.8;
            } else if (activeLanguage === 'chinese') {
                utterance.lang = 'zh-CN';
                utterance.rate = 0.7; // Slower for Chinese pronunciation
            }
            
            // Set the voice if available
            if (bestVoice) {
                utterance.voice = bestVoice;
                utterance.lang = bestVoice.lang; // Use the voice's language
                console.log(`Using voice: ${bestVoice.name} (${bestVoice.lang})`);
            }
            
            // Additional speech properties
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            // Event handlers for better UX
            utterance.onstart = function() {
                console.log('Speech started');
                // Visual feedback that speech is playing
                const speakBtn = document.querySelector('.speak-btn');
                if (speakBtn) {
                    speakBtn.textContent = 'ğŸ”Š Speaking...';
                    speakBtn.disabled = true;
                }
            };
            
            utterance.onend = function() {
                console.log('Speech ended');
                // Restore speak button
                const speakBtn = document.querySelector('.speak-btn');
                if (speakBtn) {
                    speakBtn.textContent = 'ğŸ”Š Listen';
                    speakBtn.disabled = false;
                }
            };
            
            utterance.onerror = function(event) {
                console.error('Speech error', event);
                // Restore speak button on error
                const speakBtn = document.querySelector('.speak-btn');
                if (speakBtn) {
                    speakBtn.textContent = 'ğŸ”Š Listen';
                    speakBtn.disabled = false;
                }
                
                // Try Google Translate as fallback for Malay
                if (activeLanguage === 'malay') {
                    console.log('Web Speech API failed for Malay, trying Google Translate TTS');
                    speakWithGoogleTTS(word, 'ms');
                } else {
                    alert('æ— æ³•æ’­æ”¾å£°éŸ³ï¼Œè¯·æ£€æŸ¥æ‚¨çš„è®¾å¤‡è®¾ç½®ã€‚Could not play sound, please check your device settings.');
                }
            };
            
            speechSynthesis.speak(utterance);
        }
        
        // Google Translate TTS function
        function speakWithGoogleTTS(text, lang) {
            try {
                // Visual feedback
                const speakBtn = document.querySelector('.speak-btn');
                if (speakBtn) {
                    speakBtn.textContent = 'ğŸ”Š Speaking...';
                    speakBtn.disabled = true;
                }
                
                // Create audio element for Google Translate TTS
                const encodedText = encodeURIComponent(text);
                const url = `https://translate.google.com/translate_tts?ie=UTF-8&tl=${lang}&client=tw-ob&q=${encodedText}`;
                
                const audio = new Audio(url);
                
                audio.onended = function() {
                    console.log('Google TTS Speech ended');
                    if (speakBtn) {
                        speakBtn.textContent = 'ğŸ”Š Listen';
                        speakBtn.disabled = false;
                    }
                };
                
                audio.onerror = function(error) {
                    console.error('Google TTS error:', error);
                    if (speakBtn) {
                        speakBtn.textContent = 'ğŸ”Š Listen';
                        speakBtn.disabled = false;
                    }
                    // Show user-friendly message
                    if (currentMode === 'malay') {
                        alert('Maaf, suara Bahasa Melayu tidak dapat dimainkan.\n\nPastikan telefon anda mempunyai akses internet.\n\nSorry, Malay voice cannot be played.\nPlease ensure your phone has internet access.');
                    } else {
                        alert('Could not play sound. Please check your internet connection.');
                    }
                };
                
                audio.play().catch(error => {
                    console.error('Audio play failed:', error);
                    // Try alternative method using iframe
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = url;
                    document.body.appendChild(iframe);
                    
                    setTimeout(() => {
                        document.body.removeChild(iframe);
                        if (speakBtn) {
                            speakBtn.textContent = 'ğŸ”Š Listen';
                            speakBtn.disabled = false;
                        }
                    }, 3000);
                });
                
            } catch (error) {
                console.error('Google TTS error:', error);
                const speakBtn = document.querySelector('.speak-btn');
                if (speakBtn) {
                    speakBtn.textContent = 'ğŸ”Š Listen';
                    speakBtn.disabled = false;
                }
            }
        }
        
        // Utilities
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        function createConfetti() {
            const colors = ['#ff0', '#f00', '#0f0', '#00f', '#f0f', '#0ff'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                document.body.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 3000);
            }
        }
        
        function playSuccessSound() {
            // Simple success sound using Web Audio API
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            oscillator.frequency.value = 523.25; // C5
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.5);
        }
    </script>
    <!-- Version Display - Center bottom, mobile friendly -->
    <div style="position: relative; width: 100%; text-align: center; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-top: 20px;">
        <strong>Ejaan Kids</strong> <span id="versionDisplay"></span>
        <br><small style="opacity: 0.8;">å„¿ç«¥æ‹¼å†™å­¦ä¹ åº”ç”¨</small>
    </div>
    <script>
        document.getElementById('versionDisplay').textContent = APP_VERSION;
    </script>
</body>
</html>
